<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>RHC Rurality Tiers</title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.8/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.8/"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/styles.css">

    <style>
      html,
      body,
      
   #helptext {
        border-radius: 10px;
        position: fixed;
        height: 70px;
        font-family: arial;
        margin: 5px;
        padding: 10px;
        z-index: 40;
        background: #D3D3D3;
        color: #444;
        width: auto;
        left: 65px;
        top: 15px;
        -moz-box-shadow: 0 0 10px #888;
        -webkit-box-shadow: 0 0 10px #888;
        box-shadow: 0 0 10px #888;
        border-color: #212223;
        border-width: 2px;
        border-style: solid;
             } 
  
  #splitblocks {
        border-radius: 10px;
        position: fixed;
        height: auto;
        font-family: arial;
        padding: 10px;
        z-index: 40;
        background: #D3D3D3;
        color: #444;
        width: auto;
        left: 71px;
        top: 120px;
        -moz-box-shadow: 0 0 10px #888;
        -webkit-box-shadow: 0 0 10px #888;
        box-shadow: 0 0 10px #888;
        border-color: #212223;
        border-width: 2px;
        border-style: solid;
             } 
             
             
  #ineligible_area {
        border-radius: 10px;
        position: fixed;
        height: auto;
        font-family: arial;
        padding: 10px;
        z-index: 40;
        background: #D3D3D3;
        color: #444;
        width: auto;
        left: 220px;
        top: 120px;
        -moz-box-shadow: 0 0 10px #888;
        -webkit-box-shadow: 0 0 10px #888;
        box-shadow: 0 0 10px #888;
        border-color: #212223;
        border-width: 2px;
        border-style: solid;
             } 



     
      
    </style>

    <script>
    
     
    
      require(['esri/layers/VectorTileLayer',
        "esri/Map","esri/Graphic","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/widgets/Legend","esri/tasks/Locator","esri/geometry/support/webMercatorUtils","esri/geometry/Point",
        "esri/views/MapView",
        "esri/layers/FeatureLayer","esri/widgets/Search", "esri/widgets/Home","esri/tasks/support/Query", "esri/tasks/QueryTask","esri/identity/OAuthInfo", "esri/identity/IdentityManager", "dojo/domReady!"], 
      
      function(VectorTileLayer, Map, Graphic, SimpleMarkerSymbol, SimpleFillSymbol, Legend, Locator, webMercatorUtils, Point, MapView, FeatureLayer, Search, Home, Query, QueryTask, OAuthInfo, esriId) {
        var map = new Map({
          basemap: "dark-gray"
        });

        
        
        
        
        
        
        
        
        
        
        
        
        
var info = new OAuthInfo({
  appId: "plsUr9sUTKJRu3TO",
  popup: false
});

esriId.registerOAuthInfos([info]);


        

        
        
        
        
        
        
        
        
        
        
        
      
      
      
        
        
        var view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-95.3, 38.397],
          zoom: 5
        });
        
         var home = new Home({
         view: view
          }, "HomeButton");
         view.ui.add(home, "top-left");

         var template = {
        title: 'Rural Tier'
      }
            
            // Instantiate Feature Layyer
            var vectorTileLayer = new VectorTileLayer({url:"https://tiles.arcgis.com/tiles/YnOQrIGdN9JGtBh4/arcgis/rest/services/RuralityTiersVTL/VectorTileServer"}); 
            var featureLayer = new FeatureLayer({url:"https://services.arcgis.com/YnOQrIGdN9JGtBh4/arcgis/rest/services/RuralityTiersAgain/FeatureServer/0", 
                                                 outFields: ['*'],
                                                 visible:false,
                                                 popupTemplate: template});
            map.add(vectorTileLayer);
            map.add(featureLayer);
            

           
           var search = new Search({container: "searchbar"});
           resultwindow.style.visibility='hidden';
           loadingbar.style.visibility='hidden';
           
           
        // Outer Function to Add Point and Retrieve Rurality Tier from Search Bar
           search.on('search-complete', function(result){
           
            // Show Result Window
            resultwindow.style.visibility='visible'
              
            if(result.results && result.results.length > 0 && result.results[0].results && result.results[0].results.length > 0){
            var geom = result.results[0].results[0].feature.geometry;
            }        
            
            // Set Text if No Rural Tier
            document.getElementById("resultwindow").innerHTML = 'The address provided is not in a rural tier.';
            
            // Clear Point from Previous Query
            view.graphics.removeAll();
            
            // Construct Point Symbol and Add it When Search Completes
            var point = { type: "point",  longitude: geom.longitude, latitude: geom.latitude};
            var markerSymbol = { type: "simple-marker",  color: [226, 119, 40]};
            var pointGraphic = new Graphic({geometry: point, symbol: markerSymbol});
            view.graphics.add(pointGraphic);
            
            // Zoom to New Point
            view.goTo({center: [geom.longitude, geom.latitude], zoom: 10}, {animate: true, duration: 2000});
         
            // Query to Retrieve Rurality Tier.
            var query = featureLayer.createQuery();
            query.outFields = ["Tier"];     
            query.geometry = geom  
            
            // Inner Function to Query the Layers and Set HTML Region with Result
            featureLayer.queryFeatures(query).then(function(response){
            var attribute = response.features[0].attributes;
            console.log(response)
            document.getElementById("resultwindow").innerHTML = "The address provided is located in a: " + "<span style='font-weight:bold; font-size:100%;' >"  + attribute["Tier"] + " Tier" + "</span>";
            document.getElementById("info") = search;
             });

       }); 
         
     

     
     
     
     
     
      // Outer Function to Add Point and Retrieve Rurality Tier from Click Event
          view.on('click', function (event) {
          
         loadingbar.style.visibility='visible';
         resultwindow.style.visibility='hidden';
          // Remove Graphics from Previous Click
           view.graphics.removeAll();
           
          
          // Get Coords on Mouse Click Location
           var clickcoords = view.toMap({x: event.x, y: event.y});
          
          // Construct Point Symbol and Add to Click Location
           var point = { type: "point",  longitude: clickcoords.longitude, latitude: clickcoords.latitude};
           var markerSymbol = { type: "simple-marker",  color: [226, 119, 40]};
           var pointGraphic = new Graphic({geometry: point, symbol: markerSymbol});
           view.graphics.add(pointGraphic)
         
          // Query to Retrieve Rurality Tier.
           var query = featureLayer.createQuery();
           query.outFields = ["Tier"];     
           query.geometry = clickcoords  


          // Inner Function to Query the Layers, Get the Address, and Set HTML Region with Result
           featureLayer.queryFeatures(query).then(function(response){
           var attribute = response.features[0].attributes;
           var locator = new Locator("https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer");
           var tier = attribute["Tier"]
       
           
            
           if (tier.indexOf("None") >= 0) {
           document.getElementById("resultwindow").innerHTML = 'The address provided is not in a rural tier.';
           loadingbar.style.visibility='hidden';
           resultwindow.style.visibility='visible';
           }
           else {
           locator.locationToAddress(webMercatorUtils.webMercatorToGeographic(event.mapPoint), 100).then(function(event){
            if (event.address) {
              var address = {Address: event.address};
              var location = webMercatorUtils.geographicToWebMercator(event.location)}
              document.getElementById("resultwindow").innerHTML = address["Address"] + 
              " is located in a: " + "<span style='font-weight:bold; font-size:100%;' >"  + attribute["Tier"] + 
              " Tier" + "</span>"; 
           loadingbar.style.visibility='hidden';
           resultwindow.style.visibility='visible';
              });
             }; 
           document.getElementById("info") = search;
            });
            
       });
       
/* var slideSource = document.getElementById('resultwindow');

document.getElementById('btn-closeLegend').onclick = function () {
  legend.style.visibility='hidden';
  console.log('hi');
} */
   
       
  });
     
     
$(document).ready(function(){
  $('#btn-closeLegend').click(function(){
    $("#legend").fadeOut("medium");
    $("#show_legend_button").fadeIn("medium");
  });
});

$(document).ready(function(){
  $('#show_legend_button').click(function(){
    $("#legend").fadeIn("medium");
    $("#show_legend_button").fadeOut("medium");
  });
});

      
   
      
 
      
    </script>
  </head>

 <body>
    <main class="map-container">
        <div id="btn-openLayerCtrl" class="esri-ui-corner">
            <div class="icon-layers esri-component esri-widget-button esri-widget"></div>
        </div>        
        <div id="map"></div>
        
         <div id="helptext"><strong>&nbsp Select a Rural Digital Opportunity Fund Measure </strong>
         <br><input type="radio" id="B1" name="Button" value="B1"> <label for="B3">Coverage Area</label>
         <br><input type="radio" id="B2" name="Button" value="B2"> <label for="B2">Eligible Locations</label>
         <br><input type="radio" id="B3" name="Button" value="B3"> <label for="B4">Annual Support</label>
         </div>
         
         <div id="splitblocks">
         <input type="checkbox" id="C1" name="Checkbox" value="C1"> <label for="C1"> Show Slipt Blocks </label>
         </div>
         
         <div id="ineligible_area">
         <input type="checkbox" id="C2" name="Checkbox" value="C2"> <label for="C2"> Show Ineligible Area</label>
         </div>
                

        
        
        
        
        
        
        
        
        <div class="map-legend" id='elig_area_legend'>
            <table>
                <thead>
                    <tr>
                        <td colspan="3"><span class="icon icon-list"></span> <span class="map-legend-name"> Coverage Area Legend</span>
                        </td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Eligible Area</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="key-symbol" style="background-color:#BDD7E7 "></div>
                        </td>
                </tbody>
            </table>
        </div>
        
        
        
        
                <div class="map-legend" id='elig_locs_legend'>
            <table>
                <thead>
                    <tr>
                        <td colspan="3"><span class="icon icon-list"></span> <span class="map-legend-name"> Eligible Locaions Legend</span>
                        </td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="key-symbol" style="background-color:#EDF8FB"></div>
                        </td>
                        <td>0 - 72</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="key-symbol" style="background-color:#B2E2E2"></div>
                        </td>
                        <td>73 - 188</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="key-symbol" style="background-color:#56B990"></div>
                        </td>
                        <td>189 - 339</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="key-symbol" style="background-color:#2CA25F"></div>
                        </td>
                        <td>340 - 576</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="key-symbol" style="background-color:#2CA25F"></div>
                        </td>
                        <td>577 - 1215</td>
                    </tr>
            </table>
        </div>
        

                   <div class="map-legend" id='elig_support_legend'>
            <table>
                <thead>
                    <tr>
                        <td colspan="3"><span class="icon icon-list"></span> <span class="map-legend-name"> Annual Support Legend</span>

                        </td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="key-symbol" style="background-color:#EDF8FB"></div>
                        </td>
                        <td>0 - $35,000</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="key-symbol" style="background-color:#B3CDE3 "></div>
                        </td>
                        <td>$35,001 - $98,633</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="key-symbol" style="background-color:#8C96C6"></div>
                        </td>
                        <td>$98,634 - $191,500</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="key-symbol" style="background-color:#8856A7 "></div>
                        </td>
                        <td>$191,501 - $353,887</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="key-symbol" style="background-color:#810F7C "></div>
                        </td>
                        <td>$353,887 - $972,350</td>
                    </tr>
            </table>
        </div>     
        
        
        <div class="map-legend" id='split_blocks_legend_high' style="bottom: 200px">
            <table>
                <thead>
                    <tr>
                        <td colspan="3"><span class="icon icon-list"></span> <span class="map-legend-name">Split Blocks Legend</span>
                        </td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="key-symbol-line" style="border: solid 1px #FF0000"></div>
                        </td>
                        <td>Rate of Return</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="key-symbol-line" style="border: solid 1px #00FFC5"></div>
                        </td>
                        <td>Tribal</td>
                    </tr>
                    <tr>
                    </tr>
            </table>
        </div> 
        
        
                <div class="map-legend" id='split_blocks_legend_low' style="bottom: 110px">
            <table>
                <thead>
                    <tr>
                        <td colspan="3"><span class="icon icon-list"></span> <span class="map-legend-name">Split Blocks Legend</span>
                        </td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="key-symbol-line" style="border: solid 1px #FF0000"></div>
                        </td>
                        <td>Rate of Return</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="key-symbol-line" style="border: solid 1px #00FFC5"></div>
                        </td>
                        <td>Tribal</td>
                    </tr>
                    <tr>
                    </tr>
            </table>
        </div> 
        
        
        
        
        
        
        
        
        <button id="btn-openLegend" class="btn legend__icon" title="Map Legend"><span class="icon icon-list"></span></button>
    </main>
    
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script>
    window.jQuery || document.write('<script src="../js/vendor/jquery-1.11.2.min.js"><\/script>')
    </script>
    <script src="https://js.arcgis.com/4.3/"></script>
    <script src="js/app.js"></script>
</body>
  
</html>
